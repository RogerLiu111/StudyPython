# 磁盘
## 作用：用来存放数据(二进制方式来管理数据)
## 分类：
- 机械硬盘：
    - 组成：
        1. 盘片：上面布满磁性颗粒，保存写入数据
        2. 主轴：带动盘片转动，转到磁头的下方
        3. 读写磁头：负责数据的读写
        4. 磁头臂：带动磁头，将磁头移动到指定位置
        5. 控制电路：控制硬盘的速度，磁头臂的移动等等
    - 属性：
        1. 磁道：盘片围绕在主轴周围的同心环，编号由外至内从0累加
        2. 扇区：磁道上被分成的更小单位，也是磁盘中保存数据最小的存储单元
            一般大小为512K，也有更大的扇区4K
        3. 柱面：在同一个磁盘中，所有盘片相同位置编号的磁道形成的一个圆柱
    - 工作方式：
        - 主轴带动盘片做圆周运动，磁头臂带动磁头做直线运动

- 固态硬盘：由于价格逐渐下降，容量越来越大，固态硬盘（SSD）变得越来越流行。
    - SSD原理：
        - 使用flash技术存储信息
        - 内部没有机械结构因此耗电量更小、散热小、噪音小
        - 但是，基于SSD的使用频率，SSD盘使用寿命有限。
    - SSD的3种主要的类型：
        - SLC (Single Level Cell)，单层式存储单元
            - 在SLC中，每个存储单元(cell)只存1bit数据：0或1
        - MLC (Multi Level Cell)，多层式存储单元(其实是'双层式存储单元')
            - 在MLC中，每个存储单元(cell)可存2bit数据：00,01,10,11
        - TLC (Triple Level Cell)，三层式存储单元
            - 在TLC中，每个存储单元(cell)可存3bit数据: 000, 001, 010, 011, 100, 101, 110 和111
    - 固态硬盘的磨损：
        - 对SSD盘的可靠性影响最大的是其抗磨损能力，即其cell能被擦写的次数。
        - 企业级的SLC、MLC和TLC在抗磨损方面的区别明显：
                
                        类型	容量	可擦写次数	    单位容量价格
                        SLC	    小	    约100,000	    高
                        eMLC	中等	约30,000	    中等
                        cMLC	中等	5,000 ~10,000	低
                        TLC	    大	    500 ~ 1,000	    很低
    - 固态硬盘的结构原理：
        - SSD控制器：核心控制
        - SAS 接口：6Gpbs速率
        - DDR内存：
        - FLASH：多通道并发
        - 备用电源：在掉电的时候，把FLASH中的内容写入硬盘
        
        - 优点：
            - 无高速旋转部件，性能高、功耗低
            - 多通道并发，通道内Flash颗粒复用时序
            - 支持TCQ/NCQ，一次响应多个IO请求
            - 典型响应时间低于0.1ms
        - 相较于机械硬盘优势：
            - 响应时间短
                - 机械硬盘的机械特性导致大部分时间浪费在寻道和机械延迟上，数据传输效率受到严重制约。
            - 读写效率高
                - 机械硬盘在进行随机读写操作时，磁头不停地移动，导致读写效率低下。而SSD通过内部控制器计算出数据的存放位置，直接进行存取操作，故效率高。
            - 功耗低
                - 机械硬盘旋转过程中有机械磨损，会增加功耗
        - 环境适应性优势
            - SSD不含高速旋转的机械结构部件，经得住严苛的环境考验，以华为SSD硬盘为例：
                - 可承受振动加速度16.4G，机械硬盘一般为0.5G以下
                - 抗冲击1500G，机械硬盘一般为70G左右
            - 华为SSD使用专用设备做过如下测试：
                - 静压试验、跌落试验、随机振动试验、冲击试验、碰撞试验
        - SSD在存储中的应用
            - A级应用：(访问频率高，SSD介质，最贵)以高并发随机读写为主，如数据库应用；
            - B级应用：(访问频率中，FC/SAS磁盘，偏贵)顺序读写的大容量文件、图片、流媒体等；
            - C级应用：(访问频率低，SATA/NL-SAS/磁带，便宜)以备份数据为主，或极少使用的数据。
    
## 常用总线协议/硬盘类型
- SCSI(Small Computer System Interface，小型计算机系统接口)：
    - 产生：最初由Shugart Associates NCR开发，名字为 SASI。后由ANSI承认其为工业标准，并修正为SCSI。
    - 作用：最初是一种为小型机研制的接口技术，用于主机与外部设备之间的连接通信。(最多可以连接16个设备)
    - SCSI-3：
        - 物理层：SCSI-3并行接口，IEEE串行接口，光纤通道
            - 定义信号传输方法和接口细节
        - 传输层：SCSI-3协议，光纤协议，串口总线协议，通用分组协议
            - 定义各种互相通信的协议，SCSI-3，FC等等
        - 应用层(命令层)：SCSI主要指令，SCSI特殊指令
            - 定义各种指令集
    - SCSI协议寻址：
        - 总线号：区分不同的SCSI总线
        - 设备ID：区分总线上不同的设备
        - 逻辑单元号：设备中的子设备
- ATA(Advanced Technology Attachment(IDE))：高级技术附加，为上个世纪桌面机标准磁盘，现已被淘汰
- SATA(Serial Advanced Technology Attachment)：目前桌面机主流磁盘
    - 特点：容量大，价格便宜，应用广泛
- SAS(Serial Attached SCSI)：串行SCSI协议
    - 特点：采用点对点连接方式，高带宽，效率高，支持热插拔，带宽为300M/s，600M/s
        - SAS的串行通信方式允许多个数据通路全速与各个设备通信。
        - SAS支持多个窄端口捆绑形成宽端口。
        - SAS结构采用扩展器（expander）进行接口扩展，具有非常好的扩展能力。
        - SAS采用全双工模式。
        - SAS结构采用扩展器（expander）进行接口扩展，具有非常好的扩展能力，1个SAS域最多可以连接16384个磁盘设备。
    - SAS向下兼容SATA，SAS设备能使用SATA硬盘，但是SATA设备不能使用SAS硬盘
    
## I/O操作：(input/output)
- 单个IO：
    - 操作系统内核发出一个读IO命令，当控制磁盘的控制器接到这个指令后，控制器会给磁盘发送一个读数据的指令，并同时将要读取数据块的地址传送给磁盘。然后硬盘读取数据传送给控制器，并由控制器返回给操作系统，完成一个IO操作。
        - 对硬盘级别的操作称为“块设备操作”
        - 对文件级别的操作称为“文件级别操作”
- 读写IO：
    - 写磁盘为写IO，读数据  
- 随机访问(Random Access)与连续访问(Sequential Access)：由当次IO给出的扇区地址与上次IO结束的扇区地址相差得是否较大决定，差距较大的是随机访问。
- 顺序IO模式(Queue Mode)/并发IO模式(Burst Mode)：由磁盘组一次能执行的IO命令个数决定，执行的IO命令多的叫并发IO模式。
- 单个IO的大小(I/O chunk size)/IO块大小（I/O block size）：
    - 单个IO的大小是指对于读写磁盘来说单个IO操作数据的大小，数值并不是固定的。
    - IO块大小：为了方便数据的管理，数据库、文件系统等应用程序每次读写IO的大小，大小固定。
- 完整的IO操作：
    当控制器对硬盘发出一个IO操作，磁盘的磁头臂带着读写磁头离开着陆区，然后移动到要操作初始数据块所在的磁道正上方，此过程为寻道，消耗的时间为寻道时间。
    磁头等到盘片旋转到初始数据块所在的扇区的正上方，此时才能进行数据的读取，这个过程称之为旋转时间。
    然后读取相应数据，直到完成这次IO所操作的全部数据，这个过程所花费的时间，称之为数据传送时间。

## 硬盘性能
- 机械部件
    - 影响着存储系统的整体性能
- 磁盘服务时间
    - 磁盘完成一个I/O请求的总时间：       
        - 寻道时间：用于将读/写磁头移动到要操作的初始数据块所在磁道上的时间。寻道时间越短，磁盘服务时间越短
            - 寻道时间的规格包括：
                - 全程寻道时间
                - 平均寻道时间
                - 道间寻道时间
        - 旋转时延：磁头寻道完成后，主轴旋转盘片以使得初始读写扇区位于磁头下的时间。决定于主轴的转动速度。
                - 平均转动延迟：完全旋转用时的一半
                - 附：
                        
                        5400 rpm的磁盘平均旋转时延：5.5ms
                        15000 rpm的磁盘的平均旋转时延：2.0ms
        - 数据传送时间：决定于数据传输速度，即单位时间内传输的数据量。
                - 内部传输速度：数据从盘片扇区上传送到硬盘上的内部缓存的速度。
                - 外部传输速度：接口的标称速度。通常机械硬盘的数据传输时延都是接口标称速度。
    - 完整的IO操作：当控制器对硬盘发出一个IO操作：
        - 磁盘的磁头臂带着读写磁头离开着陆区，然后移动到要操作初始数据块所在的磁道正上方，此过程为寻道，消耗的时间为寻道时间。
        - 磁头等到盘片旋转到初始数据块所在的扇区的正上方，此时才能进行数据的读取，这个过程称之为旋转时间。
        - 读取相应数据，直到完成这次IO所操作的全部数据，这个过程所花费的时间，称之为数据传送时间。
- IOPS：IO系统每秒所执行IO操作的次数，是一个重要的用来衡量系统IO能力的参数。对于单个磁盘，计算其完成一次IO所需要的时间来推算其IOPS。

                        IOTime = 寻道时间 + 60s/转速/2 + IOChunkSize/传输速度
                        IOPS = 1/IOTime = 1/(寻道时间 + 60s/转速/2 + IOChunkSize/传输速度)
    - 当单次IO越小的时候，单次IO所耗费的时间也越少，相应的IOPS也就越大。

    - 例：假设磁盘的转速(Rotational Speed)为15K RPM，平均寻道时间为5ms，最大传输速率为40MB/s，在不同的IO大小时，IOPS为：
                
                单个IO大小	寻道时间(ms)	旋转延迟(ms)	传输时延(ms)	IO服务时间(ms)	IOPS
                4K	        5	            2	            4K/40MB =0.1 	7.1	            140
                8K	        5	            2	            8K/40MB=0.2	    7.2	            139
                16K	        5	            2	            16K/40MB=0.4	7.4	            135
                32K	        5	            2	            32K/40MB=0.8	7.8	            128

- 带宽：带宽是指磁盘在实际使用的时候从磁盘系统总线上流过的数据量。也称为磁盘的实际传输速度。
                                        
                                        带宽=IOPS*IO大小
    
    - 例：接IOPS的例子，计算不同IO大小时磁盘系统的带宽

                                        单个IO大小	IOPS	带宽
                                        4K	        140	    140 * 4K = 560K /s
                                        8K	        139	    139 * 8K = 1112K /s
                                        16K	        135	    135 * 16K = 2160K /s
                                        32K	        128	    116 * 32K = 3712K /s

- 利用率和响应时间：假设某个磁盘I/O系统，应用I/O请求到达系统的速度是每秒100个I/O。I/O服务时间，RS为4毫秒。
                                
                                I/O控制器的利用率为（ U=a × Rs ）
                                总响应时间（ R=Rs /1-U ）



    